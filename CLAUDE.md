# CLAUDE.md

This file provides guidance to Claude Code when working with code in this repository.

## Project Overview

**gzh-cli-git-sync** is a library-first repository synchronization engine for the gzh ecosystem.

### Purpose

- **Library-first design**: Provides plan/execute/state/progress APIs to manage many repositories
- **Shared CLI**: Usable both as standalone `gz-git-sync` and embedded as `gz git-sync`
- **Provider-agnostic**: Takes repo specs from callers (e.g., gitforge) instead of assuming one hosting service

This module purposely does NOT bundle the entire `synclone` implementation from `gzh-cli`. Instead it rethinks the orchestration layer to be reusable outside the main CLI.

## Architecture

### Core Components

```
pkg/reposync/          → Core library (plan, execute, state, progress)
  ├── plan.go          → Turn desired repos + local state into actionable steps
  ├── executor.go      → Run steps with strategies, parallelism, retries
  ├── state.go         → Persist/restore runs for resume and auditing
  └── progress.go      → Surface events for CLI/metrics/UX

pkg/reposynccli/       → Shared CLI (Cobra commands)
  ├── run_command.go   → Main sync command
  ├── config_loader.go → YAML config parsing
  └── factory.go       → Command factory for embedding

cmd/gz-git-sync/       → Standalone binary entry point
  └── main.go
```

### Key Design Decisions

- **Default executor** uses `gzh-cli-git` to perform real Git operations
- **Planner** looks at filesystem to choose clone/update/replace
- **Orphan cleanup** supported when `cleanupOrphans` + `roots` are provided
- **State persistence** via `--state-file` for resume-able runs
- **Dot-directories** (like `.git`) are ignored in cleanup
- **Parent dirs** of nested targets are preserved

## Usage Patterns

### As Standalone Binary

```bash
gz-git-sync run --config git-sync.yaml
gz-git-sync run --config git-sync.yaml --state-file .cache/state.json --resume
```

### As Embedded Command

```go
import "github.com/Gizzahub/gzh-cli-git-sync/pkg/reposynccli"

factory := reposynccli.NewCommandFactory()
rootCmd.AddCommand(factory.NewRootCmd())
// Now accessible as: gz git-sync run --config ...
```

### Config Format

```yaml
strategy: reset          # reset|pull|fetch
parallel: 4
maxRetries: 1
dryRun: true
cleanupOrphans: true
roots:
  - ./repos
repositories:
  - name: example
    provider: github
    url: https://github.com/org/example.git
    targetPath: ./repos/example
```

### Using Existing gzh.yaml

If you have a `gzh.yaml` generated by `gz synclone`:

```bash
gz-git-sync run --config ./ORG_DIR/gzh.yaml
```

- Repositories cloned/updated into directory containing `gzh.yaml`
- `sync_mode.cleanup_orphans: true` deletes directories not listed in config

## Development

```bash
# Build
go build -o build/gz-git-sync ./cmd/gz-git-sync

# Test
go test ./...
go test ./pkg/reposync -v
```

**Dependencies**: `gzh-cli-git` (Git ops), `cobra` (CLI), `yaml.v3` (config)
**Important**: Uses replace directive for local development with `gzh-cli-git`

## Integration with gzh-cli

This library is imported by the main `gzh-cli` repository and exposed as:

```bash
gz git-sync run --config ...
```

The main CLI embeds the `reposynccli.CommandFactory` commands as a subcommand.

## Code Standards

- **Layout**: Go standard (pkg/, cmd/)
- **Interfaces**: Planner, Executor, State, Progress (testability)
- **Separation**: Business logic in pkg/reposync, CLI in pkg/reposynccli
- **Errors**: Return, don't panic
- **Logging**: Use progress events (not direct logging)

## Critical Warnings

### Replace Directives

When developing locally with gzh-cli-git:
- Uses `replace` directive in go.mod
- DO NOT commit without coordination with main devbox

### State File Location

- State files enable resume after failures
- Place in `.cache/` or `tmp/` (gitignored)
- Never commit state files

### Orphan Cleanup

- DESTRUCTIVE operation when enabled
- Only use with `roots` to limit scope
- Test with `dryRun: true` first
- Preserves dot-directories and parent paths

## Related Documentation

- Main DevBox: `../CLAUDE.md`
- gzh-cli-git: `../gzh-cli-git/CLAUDE.md`
- README: `./README.md`
